<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta http-equiv="expires" content="-1">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
   
    <!-- Bootstrap css 는 mian.css 위에-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

    <title>paymint_localhost_ngrok</title>

    <script src="http://code.jquery.com/jquery-latest.js"></script> 

    
    <style>
        html, body {
            font-family: 'NanumSquare',sans-serif;
            font-weight: 400;
            font-size: 12px;
            color: #000;
            height: 100%;
            margin:0;
            padding:0;
            scroll-behavior: smooth;
            overscroll-behavior: contain;
            word-break: keep-all;

        }
        body::-webkit-scrollbar { display: none;  }
        *,
        *:active,
        *:hover,
        *:focus {
            outline: none !important;
        }
        table {
            display: table;
            border-collapse: separate;
            -webkit-border-horizontal-spacing: 2px;
            -webkit-border-vertical-spacing: 2px;
            border-top-color: gray;
        }

        .form_wrapper {
            width: 50%;
            overflow-x: auto;
            border: 2px solid #42b983;
            margin-bottom: 0 !important;
        }

        table[data-v-90661b74] {
            border-radius: 3px;
            background-color: #fff;
        }
        .grid {
                        width: 100%;
                    }
        *:active, *:hover, *:focus {
                      outline: none !important;
                  }
        table {
            display: table;
            border-collapse: separate;
            -webkit-border-horizontal-spacing: 2px;
            -webkit-border-vertical-spacing: 2px;
            border-top-color: gray;
        }
        .grid_with_form {
            width: 50%;
            -webkit-transition: width 0.5s;
            transition: width 0.5s;
            margin-right: 15px;
        }
        .contents_grid {
                        width: 100%;
                        max-height: 600px;
                        overflow-y: auto;
                        -ms-overflow-style: none;
                        /* overflow-style: initial; */
                        overflow: auto;
                        -webkit-transition: width 0.5s;
                        transition: width 0.5s;
                        border: 2px solid #42b983;
                    }

        btn:not(:disabled):not(.disabled) {
            cursor: pointer;
        }
        .btn-outline-primary:hover {
                         color: #fff;
                         background-color: #007bff;
                         border-color: #007bff;
                     }
        .btn:focus, .btn:hover {
                         text-decoration: none;
                     }
        button:hover, a:hover {
                      cursor: pointer;
                  }
        .btn-outline-primary {
                         color: #007bff;
                         background-color: transparent;
                         background-image: none;
                         border-color: #007bff;
                     }
        .btn {
                         display: inline-block;
                         font-weight: 400;
                         text-align: center;
                         white-space: nowrap;
                         vertical-align: middle;
                         -webkit-user-select: none;
                         -moz-user-select: none;
                         -ms-user-select: none;
                         user-select: none;
                         border: 1px solid transparent;
                         padding: .375rem .75rem;
                         font-size: 1rem;
                         line-height: 1.5;
                         border-radius: .25rem;
                         transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;
                     }

        button {
            margin-top: 0em;
            font-style: normal;
            font-weight: 400;
            font-size: 11px;
            font-family: system-ui;
            font-variant-caps: normal;
            color: initial;
            letter-spacing: normal;
            word-spacing: normal;
            line-height: normal;
            text-transform: none;
            text-indent: 0px;
            text-shadow: none;
            display: inline-block;
            text-align: start;
            box-sizing:border-box;

        }
        .btn-outline-primary {
            color: #007bff;
            background-color: transparent;
            background-image: none;
            border-color: #007bff;
        }
        .input_txt {
            position: relative;
            border-radius: 8px;
            border: solid 1px #ebebeb;
            background-color: #f5f6f9;
            margin: 0;
            line-height: 30px;
            padding-left: 12px;
            padding-right: 12px;
            box-sizing: border-box;
            min-height: 30px;
            /* width: 242px; */
        }
        .input_txt input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: none;
            background-color: transparent;
            font-size: 12px;
            color: #181818;
            width: 168px;
        }
        .response_input_txt {
            position: relative;
            border-radius: 8px;
            border: solid 1px #ebebeb;
            background-color: #f5f6f9;
            margin: 0;
            line-height: 30px;
            padding-left: 12px;
            padding-right: 12px;
            box-sizing: border-box;
            min-height: 30px;
            /* width: 242px; */
        }
        .response_input_txt textarea {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: none;
            background-color: transparent;
            font-size: 12px;
            color: #181818;
            width: 100%;
            height: 200px;
        }
        input, textarea, keygen, select, button {
            margin-top: 0em;
            font-style: normal;
            font-weight: 400;
            font-size: 11px;
            font-family: system-ui;
            font-variant-caps: normal;
            color: initial;
            letter-spacing: normal;
            word-spacing: normal;
            line-height: normal;
            text-transform: none;
            text-indent: 0px;
            text-shadow: none;
            display: inline-block;
            text-align: start;
        }
        div {
            display: block;
        }

        td, th {
            display: table-cell;
            vertical-align: inherit;
        }

        .grid_with_form {
            width: 50%;
            -webkit-transition: width 0.5s;
            transition: width 0.5s;
            margin-right: 15px;
        }

        .text_label {
            padding-left: 20px;
        }
    </style>

        <script language="JavaScript">           
     
        // env.js에 NGROK_URL 변경
        let redirectUrl = "<%= user_data.bill.callbackURL %>" ;//'https://013b-175-214-28-198.ngrok-free.app/chk_paymint';
        // console.log(`0. redirectUrl, ${redirectUrl}`)
       
        let host = '';
       
      
 
        window.onload = function () {
            var _api_key = document.getElementById('api_key').value   ;      //'TEST-API-KEY-TALK';
            var _member_id = document.getElementById('member_id').value ;  //= user_data.member_id ;   //'TEST-MEMBER-FOR-API';
            var _merchant_id = document.getElementById('merchant_id').value ; //= user_data.merchant_id; //'TEST-MERCHANT-FOR-API';

            console.log(`\n\nuser_data (window.onload) : <%= JSON.stringify(user_data) %> `  ) ;
            console.log(`user_data (window.onload 22) : <%= JSON.stringify(user_data) %> ` ) ;
            
   
            // 청구서 발송 URL
            host = "http://stg.paymint.co.kr:10200/if/bill/send" ;
     
        };

        function payment() {
        
       
            var _api_key = document.getElementById('api_key').value;
            var _member_id = document.getElementById('member_id').value;
            var _merchant_id = document.getElementById('merchant_id').value;

            // _member_idx = document.getElementById('member_idx').value;
            // XMLHttpRequest 객체의 생성
            const xhr = new XMLHttpRequest();

            xhr.open('POST', host);
            xhr.setRequestHeader('Content-type', 'application/json');

            let data =         
            {                        
                "apikey": _api_key,     // TEST-API-KEY-URL (x) -> TEST-API-KEY-TALK( 0 )   
                "member": _member_id,
                "merchant": _merchant_id,
                "bill": {
                    "bill_id":"<%= user_data.bill.bill_id%>"    ,   // 꼭 20 자리 !!!
                    "hash": "<%= user_data.bill.hash %>"    , 
                    "product_nm":"<%= user_data.bill.product_nm %>"    , 
                    "message":"<%= user_data.bill.message %>"    , 
                    "member_nm":"<%= user_data.bill.member_nm %>"    , 
                    "phone":"<%= user_data.bill.phone %>"    , 
                    "price":"<%= user_data.bill.price %>"    , 
                    "expire_dt":"<%= user_data.bill.expire_dt %>"    , 
                    "callbackURL": "<%= user_data.bill.callbackURL %>"     
                    //"callbackURL":"https://013b-175-214-28-198.ngrok-free.app/chk_paymint" 
                    // "callbackURL": redirectUrl
                }        
            };

            xhr.send(JSON.stringify(data));
            console.log("1. paymint data 전송 : ",data)

            // XMLHttpRequest.readyState 프로퍼티가 변경(이벤트 발생)될 때마다 onreadystatechange 이벤트 핸들러가 호출된다.
            xhr.onreadystatechange = function (e) {

                console.log("2-0 response   : ", xhr.response);
                console.log("2-1 status     : ", xhr.status);                
                console.log("2-2 readyState : ", xhr.readyState);                
                          
                // readyStates는 XMLHttpRequest의 상태(state)를 반환
                // readyState: 4 => DONE(서버 응답 완료)
                if (xhr.readyState !== XMLHttpRequest.DONE) return;

                // resJson = JSON.parse(xhr.response);
                // alert(resJson.info)
                // 정상
                if(xhr.status === 200) {

                    resJson = JSON.parse(xhr.response);
                    // alert(resJson.info) 
                    console.log("3 callback ok : ", xhr.response);
                    // location.href = "http://0.0.0.0:14001/" +resJson.info;
                    document.getElementById('response').value = JSON.stringify(resJson, null, 4);

                    // document.getElementById('redirectUrl').value = resJson.info.url;

                    fetch("/chk_paymint", {
                        //fetch("http://stg.paymint.co.kr:10200/if/bill/send", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: xhr.response
                            // body: data
                          })
                        //.then((data) => {return data.json()})
                        .then((res) => {console.log("2-1 ",res)})
                        .catch((error) => console.log("2-2 ",error));
                        // window.location.href = '/chk' ; // 서버에서 처리함
            
                } else {
                    console.log('Error!');
                    console.log("4 전송 에러 : ", xhr.response);
                }
            };


        };
        //  XMLHttpRequest: readyState property
        //  Value	State	    Description
        //  0	    UNSENT	    Client has been created. open() not called yet.
        //  1	    PENED	    open() has been called.
        //  2	    HEADERS_    RECEIVED	send() has been called, and headers and status are available.
        //  3	    LOADING	    Downloading; responseText holds partial data.
        //  4	    DONE	    The operation is complete.

        function copyUrl() {
            const target = document.getElementById('redirectUrl');
            target.select();
            console.log(target.value);
            document.execCommand("Copy");
            alert("복사되었습니다.");
        }
    </script>
</head>

    <!-- END HEAD -->
    <body class="bg_gray">    
        
        
        <%- include('nav.ejs') %>


  <!--       <p>/paymint_user </p>
        <p>/paymint_localhost</p>
        <p>/paymint_1</p> -->
        
        <div class="contents_grid grid_with_form" style="width:100%; transform: translate(0%, 50%)">
            <%= JSON.stringify(user_data)  %>
            <table class="grid" >

                        <tr>
                            <td class="text_label"> * member_nm</td>
                            <td><div class="input_txt"><input placeholder="member_nm" id="member_nm" name="member_nm" tabindex="1" autofocus value="홍길똥"><%= user_data.bill.member_nm  %></div></td>
                        </tr>
                        <tr>
                            <td class="text_label"> * phone </td>
                            <td><div class="input_txt"><input placeholder="phone" id="phone" name="phone" tabindex="2" autofocus value="01090437295"><%= user_data.bill.phone  %></div></td>
                        </tr>
                        <tr>
                            <td class="text_label"> * price </td>
                            <td><div class="input_txt"><input placeholder="price" id="price" name="price" tabindex="3" autofocus value="20001"><%= user_data.bill.price  %></div></td>
                        </tr>
                        <tr>
                            <td class="text_label"> * product_nm </td>
                            <td><div class="input_txt"><input placeholder="product_nm" id="product_nm" name="product_nm" tabindex="4" autofocus value="상품명 - 테스트"><%= user_data.bill.product_nm  %></div></td>
                        </tr>
                        <tr>
                            <td class="text_label"> * message </td>
                            <td><div class="input_txt"><input placeholder="message" id="message" name="message" tabindex="5" autofocus value="메세지 - 코드수학학원 테스트"><%= user_data.bill.message  %></div></td>
                        </tr>
                        <tr>
                            <td class="text_label"> * bill_id </td>
                            <td><div class="input_txt"><input placeholder="bill_id" id="bill_id" name="bill_id" tabindex="4" autofocus value="bill_id"><%= user_data.bill.bill_id  %></div></td>
                        </tr>
                        <tr>
                            <td class="text_label"> * hash </td>
                            <td><div class="input_txt" ><input   id="hash" ><%= user_data.bill.hash  %></div></td>
                        </tr>




                <tr>
                	<td></td>
                    <td colspan="2" style="text-align: left;">
                        <button style="width: 30%; margin: 20px 0px 30px 0px" type="button" class="btn btn-outline-primary" onclick="javascript:payment();">결제하기</button>
                    </td>
                </tr>

                
                <tr>
                    <td class="text_label"> * API Key 파트너</td>
                    <td><div class="input_txt"><input placeholder="API Key" id="api_key" name="api_key" tabindex="1" autofocus value="TEST-API-KEY-TALK"></div></td>
                </tr>
                <tr>
                    <td class="text_label"> * ERP 회원 아이디 </td>
                    <td><div class="input_txt"><input placeholder="회원아이디" id="member_id" name="member_id" tabindex="2" autofocus value="TEST-MEMBER-FOR-API"></div></td>
                </tr>
              	<tr>
                    <td class="text_label"> * ERP 가맹점 아이디 </td>
                    <td><div class="input_txt"><input placeholder="가맹점아이디" id="merchant_id" name="merchant_id" tabindex="3" autofocus value="TEST-MERCHANT-FOR-API"></div></td>
                </tr>

                <tr>
                	<td></td>
                    <td colspan="2" style="text-align: left;">
                        <button style="width: 30%; margin: 20px 0px 30px 0px" type="button" class="btn btn-outline-primary" onclick="javascript:login();">로그인</button>
                    </td>
                </tr>

                <tr>
                    <td class="text_label"> * 응답 값 
                        <p id = 'time' value = 'time'></p>
                        <p id = 'redirectUrl' value = 'redirectUrl'></p>                      
                        
                    </td>
                    <td><div class="response_input_txt">
                    	<textarea id="response" name="response" tabindex="1" autofocus value="" readonly></textarea>
                    </div>
                    </td>
                </tr>
                <tr>
                	<td></td>
                    <td colspan="2" style="text-align: left;">
                        <button style="width: 15%; margin: 20px 0px 20px 0px" type="button" class="btn btn-outline-primary" onclick="javascript:copyUrl();">응답 URL 복사하기</button>
                        <input type="text" id="redirectUrl" value="" style="position:absolute;top:-9999em;">
                    </td>
                </tr>
                <tr>
            </table>
        </div>
        
        <script>
            let today = new Date();       
            var year = today.getFullYear();
            var month = ('0' + (today.getMonth() + 1)).slice(-2);
            var day = ('0' + today.getDate()).slice(-2);
            var hour = ('0' + today.getHours()).slice(-2);
            var minutes = ('0' + today.getMinutes()).slice(-2);
            var seconds = ('0' + today.getSeconds()).slice(-2);  
            var dateString = year + '-' + month  + '-' + day+' '+hour+':'+minutes+':'+seconds;
            console.log('접속시간 : ', dateString)    ;
            document.getElementById('time').innerHTML = dateString ;
            document.getElementById('redirectUrl').innerHTML = redirectUrl ;
            
            // $("#time").html(dateString) ;
          </script>
    </body>
</html>
